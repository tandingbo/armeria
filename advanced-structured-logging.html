

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Structured logging &mdash; Armeria 0.64.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Structured logging with Kafka" href="advanced-structured-logging-kafka.html" />
    <link rel="prev" title="Logging contextual information" href="advanced-logging.html" />
  <script src="_static/center_page.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
   


  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html">
          

          
            
            <img src="_static/armeria.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.64
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setting up a project</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">Writing a server</a></li>
<li class="toctree-l1"><a class="reference internal" href="client.html">Writing a client</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="advanced.html">Advanced topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="advanced-logging.html">Logging contextual information</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Structured logging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-properties-can-be-retrieved">What properties can be retrieved?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#availability-of-properties">Availability of properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="#set-serializationformat-and-requestcontent-early-if-possible">Set <tt class="docutils literal">serializationFormat</tt> and <tt class="docutils literal">requestContent</tt> early if possible</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nested-log">Nested log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="advanced-structured-logging-kafka.html">Structured logging with Kafka</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced-zipkin.html">Zipkin integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced-zookeeper.html">Service discovery with ZooKeeper</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria/releases">Release notes</a></li>
<li class="toctree-l1"><a class="reference external" href="apidocs/index.html#://">API documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="xref/index.html#://">Source cross-reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria/issues?q=label%3Aquestion-answered">Questions and answers</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria">Fork me at GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md">Contributing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Armeria</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="advanced.html">Advanced topics</a> &raquo;</li>
        
      <li>Structured logging</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/line/armeria/blob/master/site/src/sphinx/advanced-structured-logging.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="structured-logging">
<span id="advanced-structured-logging"></span><h1>Structured logging<a class="headerlink" href="#structured-logging" title="Permalink to this headline">¶</a></h1>
<p>Although traditional logging is a useful tool to diagnose the behavior of an application, it has its own
problem; the resulting log messages are not always machine-friendly. This section explains the Armeria API for
retrieving the information collected during request life cycle in a machine-friendly way.</p>
<div class="section" id="what-properties-can-be-retrieved">
<h2>What properties can be retrieved?<a class="headerlink" href="#what-properties-can-be-retrieved" title="Permalink to this headline">¶</a></h2>
<p><code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code> provides all the properties you can retrieve:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">Request properties</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal">requestStartTimeMillis</tt></td>
<td>when the request processing started</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal">requestDurationNanos</tt></td>
<td>the duration took to process the request completely</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal">requestLength</tt></td>
<td>the byte length of the request content</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal">requestCause</tt></td>
<td>the cause of request processing failure (if any)</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal">sessionProtocol</tt></td>
<td>the protocol of the connection (e.g. <tt class="docutils literal">H2C</tt>)</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal">serializationFormat</tt></td>
<td>the serialization format of the content (e.g. <tt class="docutils literal">tbinary</tt>, <tt class="docutils literal">none</tt>)</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal">host</tt></td>
<td>the name of the virtual host that serves the request</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal">requestHeaders</tt></td>
<td>the HTTP headers of the request.
the header contains the method (e.g. <tt class="docutils literal">GET</tt>, <tt class="docutils literal">POST</tt>),
the path (e.g. <tt class="docutils literal">/thrift/foo</tt>),
the query (e.g. <tt class="docutils literal">foo=bar&bar=baz</tt>), the content type, etc.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal">requestContent</tt></td>
<td>the serialization-dependent content object of the request.
<tt class="docutils literal">ThriftCall</tt> for Thrift. <tt class="docutils literal">null</tt> otherwise.</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head" colspan="2">Response properties</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal">responseStartTimeMillis</tt></td>
<td>when the response processing started</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal">responseDurationNanos</tt></td>
<td>the duration took to process the response completely</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal">responseLength</tt></td>
<td>the byte length of the response content</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal">responseCause</tt></td>
<td>the cause of response processing failure (if any)</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal">totalDurationNanos</tt></td>
<td>the duration between the request start and the response end
(i.e. response time)</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal">responseHeaders</tt></td>
<td>the HTTP headers of the response.
the header contains the statusCode (e.g. 404), the content type, etc.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal">responseContent</tt></td>
<td>the serialization-dependent content object of the response.
<tt class="docutils literal">ThriftReply</tt> for Thrift. <tt class="docutils literal">null</tt> otherwise.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="availability-of-properties">
<h2>Availability of properties<a class="headerlink" href="#availability-of-properties" title="Permalink to this headline">¶</a></h2>
<p>Armeria handles requests and responses in a stream-oriented way, which means that some properties are revealed
only after the streams are processed to some point. For example, there’s no way to know the <tt class="docutils literal">requestLength</tt>
until the request processing ends. Also, some properties related to the (de)serialization of request content,
such as <tt class="docutils literal">serializationFormat</tt> and <tt class="docutils literal">requestContent</tt>, will not be available when request processing just
started.</p>
<p>To get notified when a certain set of properties are available, you can add a listener to a <tt class="docutils literal">RequestLog</tt>:</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.common.HttpRequest;
import com.linecorp.armeria.common.HttpResponse;
import com.linecorp.armeria.common.logging.RequestLog;
import com.linecorp.armeria.common.logging.RequestLogAvailability;
import com.linecorp.armeria.server.ServiceRequestContext;
import com.linecorp.armeria.server.AbstractHttpService;

public class MyService extends AbstractHttpService {
    @Override
    public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) {
        final RequestLog log = ctx.log();

        log.addListener(log -&gt; {
            System.err.println(&quot;Handled a request: &quot; + log);
        }, RequestLogAvailability.COMPLETE);

        return super.serve(ctx, req);
    }
}</pre></div>
</div>
<p>Note that <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLogAvailability.html">RequestLogAvailability</a></code> is specified when adding a listener.
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLogAvailability.html">RequestLogAvailability</a></code> is an enum that is used to express which <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code> properties
you are interested in. <tt class="docutils literal">COMPLETE</tt> will make your listener invoked when all properties are available.</p>
</div>
<div class="section" id="set-serializationformat-and-requestcontent-early-if-possible">
<h2>Set <tt class="docutils literal">serializationFormat</tt> and <tt class="docutils literal">requestContent</tt> early if possible<a class="headerlink" href="#set-serializationformat-and-requestcontent-early-if-possible" title="Permalink to this headline">¶</a></h2>
<p>Armeria depends on the <tt class="docutils literal">serializationFormat</tt> and <tt class="docutils literal">requestContent</tt> property to determine whether a request
is an RPC and what the method name of the call is. If you are sure the request you handle is not an RPC, set
the <tt class="docutils literal">serializationFormat</tt> and <tt class="docutils literal">requestContent</tt> property explicitly to <tt class="docutils literal">NONE</tt> and <tt class="docutils literal">null</tt> so that Armeria
and other log listeners get the information sooner:</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.common.HttpRequest;
import com.linecorp.armeria.common.HttpResponse;
import com.linecorp.armeria.common.SerializationFormat;
import com.linecorp.armeria.server.ServiceRequestContext;
import com.linecorp.armeria.server.HttpService;

public class MyService implements HttpService {
    @Override
    public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) {
        ctx.logBuilder().serializationFormat(SerializationFormat.NONE);
        ctx.logBuilder().requestContent(null);
        ...
    }
}</pre></div>
</div>
<p>Consider using <tt class="docutils literal">AbstractHttpService</tt> which sets the <tt class="docutils literal">serializationFormat</tt> and <tt class="docutils literal">requestContent</tt>
automatically for you:</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.common.HttpResponseWriter;
import com.linecorp.armeria.common.thrift.ThriftSerializationFormats;
import com.linecorp.armeria.server.AbstractHttpService;

public class MyService extends AbstractHttpService {
    @Override
    public void doGet(ServiceRequestContext ctx, HttpRequest req, HttpResponseWriter res) {
        // serializationFormat and requestContent will be set to NONE and null
        // automatically when this method returns.
        ...
    }

    @Override
    public void doPost(ServiceRequestContext ctx, HttpRequest req, HttpResponseWriter res) {
        // Set serializationFormat explicitly.
        ctx.logBuilder().serializationFormat(ThriftSerializationFormats.BINARY);
        // This will prevent AbstractHttpService from setting requestContent to null
        // automatically. You should call RequestLogBuilder.requestContent(...) later
        // when the content is determined.
        ctx.logBuilder().deferRequestContent();
        // Alternatively, you can set requestContent right here:
        // ctx.logBuilder().requestContent(...);
        ...
    }
}</pre></div>
</div>
</div>
<div class="section" id="nested-log">
<span id="id1"></span><h2>Nested log<a class="headerlink" href="#nested-log" title="Permalink to this headline">¶</a></h2>
<p>When you retry a failed attempt, you might want to record the result of each attempt and to group them under
a single <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code>. A <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code> can contain more than one child <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code>
to support this sort of use cases.</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.common.logging.RequestLogBuilder;

RequestLogBuilder.addChild(RequestLog);</pre></div>
</div>
<p>If the added <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code> is the first child, the request-side log of the <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code> will
be propagated to the parent log. You can add as many child logs as you want, but the rest of logs would not
be affected. If you want to fill the response-side log of the parent log, please invoke:</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">RequestLogBuilder.endResponseWithLastChild();</pre></div>
</div>
<p>This will propagate the response-side log of the last added child to the parent log. The following diagram
illustrates how a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/logging/RequestLog.html">RequestLog</a></code> with child logs looks like:</p>
<p class="plantuml">
<img src="_images/plantuml-77308ffbcf7f2b77a478813eeab0f78a8a56906d.png" alt="&#64;startditaa(--no-separation, scale=0.85)
/--------------------------------------------------------------\
|                                                              |
|  RequestLog                                                  |
|                                                              |
|                             /-----------------------------\  |
|                             :                             |  |
|  +----------------------+   |      Child RequestLogs      |  |
|  |                      |   |        e.g. retries         |  |
|  |                      |   |                             |  |
|  |   Request side log   |   |  +-----------------------+  |  |
|  |                      |   |  | Child #1              |  |  |
|  |                      |   |  | +-------------------+ |  |  |
|  |     Copied from      |&lt;-------+ Request side log  | |  |  |
|  |     the first child  |   :  | +-------------------+ |  |  |
|  |                      |   |  | : Response side log | |  |  |
|  |                      |   |  | +-------------------+ |  |  |
|  +----------------------+   |  +-----------------------+  |  |
|                             |  | ...                   |  |  |
|  +----------------------+   |  +-----------------------+  |  |
|  |                      |   |              .              |  |
|  |                      |   |              .              |  |
|  |  Response side log   |   |  +-----------------------+  |  |
|  |                      |   |  | Child #N              |  |  |
|  |                      |   |  | +-------------------+ |  |  |
|  |     Copied from      |   |  | : Request side log  | |  |  |
|  |     the last child   |   |  | +-------------------+ |  |  |
|  |                      |&lt;-------+ Response side log | |  |  |
|  |                      |   :  | +-------------------+ |  |  |
|  +----------------------+   |  +-----------------------+  |  |
|                             |                             |  |
|                             \-----------------------------/  |
|                                                              |
\--------------------------------------------------------------/
&#64;endditaa" />
</p>
<p>You can retrieve the child logs using <tt class="docutils literal">RequestLog.children()</tt>.</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">final RequestContext ctx = ...;
ctx.log().addListner(log -&gt; {
    if (!log.children().isEmpty()) {
        System.err.println(&quot;A request finished after &quot; + log.children().size() + &quot; attempt(s): &quot; + log);
    } else {
        System.err.println(&quot;A request is done: &quot; + log);
    }
}, RequestLogAvailability.COMPLETE);</pre></div>
</div>
<p><code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/retry/RetryingClient.html">RetryingClient</a></code> is a good example that leverages this feature.
See <a class="reference internal" href="client-retry.html#retry-with-logging"><span class="std std-ref">RetryingClient with logging</span></a> for more information.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="advanced-structured-logging-kafka.html" class="btn btn-neutral float-right" title="Structured logging with Kafka" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="advanced-logging.html" class="btn btn-neutral" title="Logging contextual information" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2018, LINE Corporation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.64.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script>
  <div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
      <a href="https://github.com/line/armeria">Fork me at GitHub</a>
    </div>
  </div>
  <script type="text/javascript" src="_static/add_badges.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.3.0/highlightjs-line-numbers.min.js"></script>
  <script>
    document.querySelectorAll('div.hljs > pre').forEach(function(block) {
      hljs.highlightBlock(block);
      hljs.lineNumbersBlock(block);
    });
  </script>
   


</body>
</html>