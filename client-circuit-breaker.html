

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Circuit breaker &mdash; Armeria 0.64.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Client-side load balancing and service discovery" href="client-service-discovery.html" />
    <link rel="prev" title="Automatic retry" href="client-retry.html" />
  <script src="_static/center_page.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
   


  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html">
          

          
            
            <img src="_static/armeria.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.64
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setting up a project</a></li>
<li class="toctree-l1"><a class="reference internal" href="server.html">Writing a server</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="client.html">Writing a client</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="client-http.html">Calling an HTTP service</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-retrofit.html">Retrofit integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-thrift.html">Calling a Thrift service</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-grpc.html">Calling a gRPC service</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-decorator.html">Decorating a client</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-custom-http-headers.html">Sending custom HTTP headers</a></li>
<li class="toctree-l2"><a class="reference internal" href="client-retry.html">Automatic retry</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Circuit breaker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#state-of-circuitbreaker">State of <tt class="docutils literal">CircuitBreaker</tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="#circuitbreakerclient"><tt class="docutils literal">CircuitBreakerClient</tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="#circuitbreakerstrategy"><tt class="docutils literal">CircuitBreakerStrategy</tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="#grouping-circuitbreakers">Grouping <tt class="docutils literal">CircuitBreakers</tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="#circuitbreakerbuilder"><tt class="docutils literal">CircuitBreakerBuilder</tt></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="client-service-discovery.html">Client-side load balancing and service discovery</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced topics</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria/releases">Release notes</a></li>
<li class="toctree-l1"><a class="reference external" href="apidocs/index.html#://">API documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="xref/index.html#://">Source cross-reference</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria/issues?q=label%3Aquestion-answered">Questions and answers</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria">Fork me at GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md">Contributing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Armeria</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="client.html">Writing a client</a> &raquo;</li>
        
      <li>Circuit breaker</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/line/armeria/blob/master/site/src/sphinx/client-circuit-breaker.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="circuit-breaker">
<span id="client-circuit-breaker"></span><h1>Circuit breaker<a class="headerlink" href="#circuit-breaker" title="Permalink to this headline">¶</a></h1>
<p>In microservice architecture, it’s common that various services running on different machines are connected to
each other through remote calls. If one of the services becomes unreachable somehow such as due to network
issues, the client which connects to that service will take long to get a response from it or to fail to
get one. Situation will get even worse if there are many remote calls to such unresponsive service.
You can configure an Armeria client with a circuit breaker to prevent this circumstance. The circuit breaker
can automatically detect failures by continuously updating success and failure events. If the remote service
is unresponsive, it will immediately respond with an error and not make remote calls.
Please refer to <a class="reference external" href="https://martinfowler.com/bliki/CircuitBreaker.html">CircuitBreaker wiki page</a> by Martin Fowler and
<a class="reference external" href="https://engineering.linecorp.com/en/blog/detail/76">LINE Engineering blog post about circuit breaker</a> for more information.</p>
<div class="section" id="state-of-circuitbreaker">
<h2>State of <tt class="docutils literal">CircuitBreaker</tt><a class="headerlink" href="#state-of-circuitbreaker" title="Permalink to this headline">¶</a></h2>
<p>A <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> can be one of the following three states:</p>
<ul class="simple">
<li><tt class="docutils literal">CLOSED</tt><ul>
<li>Initial state. All requests are treated normally.</li>
</ul>
</li>
<li><tt class="docutils literal">OPEN</tt><ul>
<li>The state machine enters the <tt class="docutils literal">OPEN</tt> state once the number of failures divided by the total number of
requests exceeds a certain threshold. All requests are blocked off responding with <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/FailFastException.html">FailFastException</a></code>.</li>
</ul>
</li>
<li><tt class="docutils literal">HALF_OPEN</tt>.<ul>
<li>After a certain amount of time in the <tt class="docutils literal">OPEN</tt> state, the state machine enters the <tt class="docutils literal">HALF_OPEN</tt> state
which sends a request to find out if the service is still unavailable or not.
If the request succeeds, it enters the <tt class="docutils literal">CLOSED</tt> state. If it fails, it enters the <tt class="docutils literal">OPEN</tt> state again.</li>
</ul>
</li>
</ul>
<p class="plantuml">
<img src="_images/plantuml-f98b92eeb687a1152868ec1617e14da615a16077.png" alt="&#64;startditaa(--no-separation)

                                   +----------------+
                                   |                |
                                   |      OPEN      |
                                   |                |&lt;-------------------+
                                   +------------+---+     failed again   |
                                       ^        |                        |
                                       |        |                        |
                                       |        |                        |
                                       |        |                        |
 under threshold                       |        |                        |
     +---+                             |        |                        |
     |   |                             |        |                        |
     |   v                             |        |                        |
+----+-----------+  exceeded threshold |        |     timed out       +--+-------------+
|                +---------------------+        +--------------------&gt;|                |
|     CLOSED     |                                                    |    HALF_OPEN   |
|                |&lt;---------------------------------------------------+                |
+----------------+          back to normal (request succeeded)        +----------------+

&#64;endditaa" />
</p>
</div>
<div class="section" id="circuitbreakerclient">
<h2><tt class="docutils literal">CircuitBreakerClient</tt><a class="headerlink" href="#circuitbreakerclient" title="Permalink to this headline">¶</a></h2>
<p>Armeria provides two different <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/Client.html">Client</a></code> implementations depending on the
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Request.html">Request</a></code> and <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Response.html">Response</a></code> types:</p>
<ul class="simple">
<li><code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerHttpClient.html">CircuitBreakerHttpClient</a></code></li>
<li><code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerRpcClient.html">CircuitBreakerRpcClient</a></code></li>
</ul>
<p>Let’s use <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerHttpClient.html">CircuitBreakerHttpClient</a></code> to find out what we can do.
You can use the <tt class="docutils literal">decorator()</tt> method in <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/ClientBuilder.html">ClientBuilder</a></code> to build a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerHttpClient.html">CircuitBreakerHttpClient</a></code>:</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.client.circuitbreaker.CircuitBreaker;
import com.linecorp.armeria.client.circuitbreaker.CircuitBreakerHttpClient;
import com.linecorp.armeria.client.circuitbreaker.CircuitBreakerStrategy;
import com.linecorp.armeria.client.ClientBuilder;
import com.linecorp.armeria.client.HttpClient;
import com.linecorp.armeria.common.HttpRequest;
import com.linecorp.armeria.common.HttpResponse;

final CircuitBreakerStrategy&lt;HttpResponse&gt; strategy = CircuitBreakerStrategy.onServerErrorStatus();
final CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaultName();
final HttpClient client = new ClientBuilder(...)
        .decorator(HttpRequest.class, HttpResponse.class,
                   CircuitBreakerHttpClient.newDecorator(circuitBreaker, strategy))
        .build(HttpClient.class);

client.execute(...).aggregate().join(); // Send requests on and on.</pre></div>
</div>
<p>Now, the <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/Client.html">Client</a></code> can track the number of success or failure events depending on the <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Response.html">Response</a><span class="code api-reference plural-suffix">s</span></code>.
The <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> will enter <tt class="docutils literal">OPEN</tt>, when the number of failures divided by the total number of
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Request.html">Request</a><span class="code api-reference plural-suffix">s</span></code> exceeds the failure rate. Then the <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/Client.html">Client</a></code> will immediately get
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/FailFastException.html">FailFastException</a></code> by the <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code>.</p>
</div>
<div class="section" id="circuitbreakerstrategy">
<span id="circuit-breaker-strategy"></span><h2><tt class="docutils literal">CircuitBreakerStrategy</tt><a class="headerlink" href="#circuitbreakerstrategy" title="Permalink to this headline">¶</a></h2>
<p>How does a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> know whether a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Response.html">Response</a></code> is successful or not?
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerStrategy.html">CircuitBreakerStrategy</a></code> does the job. In the example above, if the status of a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Response.html">Response</a></code> is <tt class="docutils literal">5xx</tt>
or an <tt class="docutils literal">Exception</tt> is raised during the call, the count of failure is increased.
Of course, you can have your own <tt class="docutils literal">strategy</tt> by implementing <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerStrategy.html">CircuitBreakerStrategy</a></code>.
The following example shows a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerStrategy.html">CircuitBreakerStrategy</a></code> implementation that fails when an <tt class="docutils literal">Exception</tt>
is raised or the status is <tt class="docutils literal">5xx</tt>, succeeds when the status is <tt class="docutils literal">2xx</tt> and ignores others.</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.common.HttpStatusClass;

final CircuitBreakerStrategy&lt;HttpResponse&gt; myStrategy = new CircuitBreakerStrategy&lt;HttpResponse&gt;() {

    @Override
    public CompletableFuture&lt;Boolean&gt; shouldReportAsSuccess(HttpResponse response) {
        return response.aggregate().handle((res, cause) -&gt; {
            if (cause != null) { // A failure if an Exception is raised.
                return false;
            }

            final HttpStatus status = res.status();
            if (status != null) {
                // A failure if the response is 5xx.
                if (status.codeClass() == HttpStatusClass.SERVER_ERROR) {
                    return false;
                }

                // A success if the response is 2xx.
                if (status.codeClass() == HttpStatusClass.SUCCESS) {
                    return true;
                }
            }

            // Neither a success nor a failure. Do not take this response into account.
            return null;
        });
    }
};</pre></div>
</div>
<p>If you want to treat a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Response.html">Response</a></code> as a success, return <tt class="docutils literal">true</tt>. Return <tt class="docutils literal">false</tt> to treat as a failure.
Note that <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerStrategy.html">CircuitBreakerStrategy</a></code> can return <tt class="docutils literal">null</tt> as well. It won’t be counted as a success nor
a failure.</p>
</div>
<div class="section" id="grouping-circuitbreakers">
<h2>Grouping <tt class="docutils literal">CircuitBreakers</tt><a class="headerlink" href="#grouping-circuitbreakers" title="Permalink to this headline">¶</a></h2>
<p>In the very first example above, a single <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> was used to track the events. However,
in many cases, you will want to use different <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> for different endpoints. For example, there
might be an API which performs heavy calculation which fails often. On the other hand, there can be another API
which is not resource hungry and this is not likely to fail.
Having one <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> that tracks all the success and failure does not make sense in this scenario.
It’s even worse if the <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/Client.html">Client</a></code> connects to the services on different machines.
When one of the remote services is down, your <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> will probably be <tt class="docutils literal">OPEN</tt> state although
you can connect to other services.
Therefore, Armeria provides various ways that let users group the range of circuit breaker instances.</p>
<ul>
<li><p class="first">Group by host: a single <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> is used for each remote host.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.client.circuitbreaker.CircuitBreakerRpcClient;
import com.linecorp.armeria.common.RpcResponse;

// Create a CircuitBreaker with the key name
final Function&lt;String, CircuitBreaker&gt; factory = key -&gt; CircuitBreaker.of(&quot;my-cb-&quot; + key);
final CircuitBreakerStrategy&lt;HttpResponse&gt; httpStrategy = CircuitBreakerStrategy.onServerErrorStatus();
final CircuitBreakerStrategy&lt;RpcResponse&gt; rpcStrategy =
        response -&gt; response.completionFuture().handle((res, cause) -&gt; cause == null);

// Create CircuitBreakers per host (a.com, b.com ...)
CircuitBreakerHttpClient.newPerHostDecorator(factory, httpStrategy);
CircuitBreakerRpcClient.newPerHostDecorator(factory, rpcStrategy);
// The names of the created CircuitBreaker: my-cb-a.com, my-cb-b.com, ...</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Group by method: a single <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> is used for each method.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">// Create CircuitBreakers per method
CircuitBreakerHttpClient.newPerMethodDecorator(factory, httpStrategy);
// The names of the created CircuitBreaker: my-cb-GET, my-cb-POST, ...

CircuitBreakerRpcClient.newPerMethodDecorator(factory, rpcStrategy);
// The names of the created CircuitBreaker: my-cb-methodA, my-cb-methodB, ...</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Group by host and method: a single <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> is used for each method and host combination.</p>
<blockquote>
<div><div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">// Create CircuitBreakers per host and method
CircuitBreakerHttpClient.newPerHostAndMethodDecorator(factory, httpStrategy);
// The names of the created CircuitBreaker: my-cb-a.com#GET,
// my-cb-a.com#POST, my-cb-b.com#GET, my-cb-b.com#POST, ...

CircuitBreakerRpcClient.newPerHostAndMethodDecorator(factory, rpcStrategy);
// The names of the created CircuitBreaker: my-cb-a.com#methodA,
// my-cb-a.com#methodB, my-cb-b.com#methodA, my-cb-b.com#methodB, ...</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>If you want none of the above groupings, you can group them however you want using
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/KeyedCircuitBreakerMapping.html">KeyedCircuitBreakerMapping</a></code> and <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/KeyedCircuitBreakerMapping.KeySelector.html">KeyedCircuitBreakerMapping.KeySelector</a></code>.</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.client.circuitbreaker.KeyedCircuitBreakerMapping;
import com.linecorp.armeria.client.circuitbreaker.KeyedCircuitBreakerMapping.KeySelector;

// I want to create CircuitBreakers per path!
final KeyedCircuitBreakerMapping&lt;String&gt; mapping =
        new KeyedCircuitBreakerMapping&lt;&gt;((ctx, req) -&gt; ctx.path(), factory);

CircuitBreakerHttpClient.newDecorator(mapping, httpStrategy);</pre></div>
</div>
</div>
<div class="section" id="circuitbreakerbuilder">
<h2><tt class="docutils literal">CircuitBreakerBuilder</tt><a class="headerlink" href="#circuitbreakerbuilder" title="Permalink to this headline">¶</a></h2>
<p>We have used static factory methods in <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> interface to create a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> so far.
If you use <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreakerBuilder.html">CircuitBreakerBuilder</a></code>, you can configure the parameters which decide
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code>’s behavior. Here are the parameters:</p>
<ul>
<li><p class="first"><tt class="docutils literal">name</tt>:</p>
<ul class="simple">
<li>The name of the <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code>.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">failureRateThreshold</tt>:</p>
<ul class="simple">
<li>The threshold that changes <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code>’s state to <tt class="docutils literal">OPEN</tt> when the number of failed
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Request.html">Request</a><span class="code api-reference plural-suffix">s</span></code> divided by the number of total <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Request.html">Request</a><span class="code api-reference plural-suffix">s</span></code> exceeds it.
The default value is <tt class="docutils literal">0.2</tt>.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">minimumRequestThreshold</tt>:</p>
<ul class="simple">
<li>The minimum number of <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Request.html">Request</a><span class="code api-reference plural-suffix">s</span></code> to detect failures. The default value is <tt class="docutils literal">10</tt>.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">trialRequestInterval</tt>:</p>
<ul class="simple">
<li>The duration that a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> remains in <tt class="docutils literal">HALF_OPEN</tt> state. All requests are blocked off
responding with <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/FailFastException.html">FailFastException</a></code> during this state. The default value is <tt class="docutils literal">3</tt> seconds.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">circuitOpenWindow</tt>:</p>
<ul class="simple">
<li>The duration that a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> remains in <tt class="docutils literal">OPEN</tt> state. All <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Request.html">Request</a><span class="code api-reference plural-suffix">s</span></code> are blocked
off responding with <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/FailFastException.html">FailFastException</a></code> during this state. The default value is <tt class="docutils literal">10</tt> seconds.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">counterSlidingWindow</tt>:</p>
<ul class="simple">
<li>The duration of a sliding window that a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> counts successful and failed
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/common/Request.html">Request</a><span class="code api-reference plural-suffix">s</span></code> in it. The default value is <tt class="docutils literal">20</tt> seconds.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">counterUpdateInterval</tt>:</p>
<ul class="simple">
<li>The duration that a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> stores events in a bucket. The default value is <tt class="docutils literal">1</tt> second.</li>
</ul>
</li>
<li><p class="first"><tt class="docutils literal">listeners</tt>:</p>
<ul>
<li><p class="first">The listeners which are notified by a <code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/CircuitBreaker.html">CircuitBreaker</a></code> when an event occurs. The events are one of
<tt class="docutils literal">stateChanged</tt>, <tt class="docutils literal">eventCountUpdated</tt> and <tt class="docutils literal">requestRejected</tt>. You can use
<code class="code api-reference docutils literal javadoc"><a class="code api-reference reference external javadoc" href="apidocs/index.html?com/linecorp/armeria/client/circuitbreaker/MetricCollectingCircuitBreakerListener.html">MetricCollectingCircuitBreakerListener</a></code> to export metrics:</p>
<div class="highlight-java notranslate"><div class="highlight hljs"><pre class="java">import com.linecorp.armeria.client.circuitbreaker.MetricCollectingCircuitBreakerListener

import io.micrometer.core.instrument.Metrics;

final MetricCollectingCircuitBreakerListener listener =
        new MetricCollectingCircuitBreakerListener(Metrics.globalRegistry);
final CircuitBreakerBuilder builder = new CircuitBreakerBuilder().listener(listener);</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="client-service-discovery.html" class="btn btn-neutral float-right" title="Client-side load balancing and service discovery" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="client-retry.html" class="btn btn-neutral" title="Automatic retry" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-2018, LINE Corporation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.64.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script>
  <div class="github-fork-ribbon-wrapper right">
    <div class="github-fork-ribbon">
      <a href="https://github.com/line/armeria">Fork me at GitHub</a>
    </div>
  </div>
  <script type="text/javascript" src="_static/add_badges.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.3.0/highlightjs-line-numbers.min.js"></script>
  <script>
    document.querySelectorAll('div.hljs > pre').forEach(function(block) {
      hljs.highlightBlock(block);
      hljs.lineNumbersBlock(block);
    });
  </script>
   


</body>
</html>